<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - UPike Parking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0b0b0b, #1a1a1a);
      font-family: 'Inter', sans-serif;
      color: #f5f5f5;
      overflow-x: hidden;
    }
    .upike-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(242, 105, 37, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(242, 105, 37, 0.1);
      border-radius: 1.5rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .upike-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(242, 105, 37, 0.2);
      border-color: rgba(242, 105, 37, 0.4);
    }
    .upike-button {
      background: linear-gradient(45deg, #F26925, #e07a3a);
      box-shadow: 0 4px 15px rgba(242, 105, 37, 0.3);
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .upike-button:hover {
      box-shadow: 0 6px 25px rgba(242, 105, 37, 0.5);
      transform: translateY(-2px);
    }
    .upike-button:active {
      transform: scale(0.98);
    }
    .upike-button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: translateX(-100%);
      transition: 0.5s;
    }
    .upike-button:hover::after {
      transform: translateX(100%);
    }
    .upike-subtitle {
      color: #F26925;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(242, 105, 37, 0.2);
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    .upike-subtitle::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: #F26925;
      transition: width 0.3s ease;
    }
    .upike-subtitle:hover::after {
      width: 100%;
    }
    .table-hover tr:hover {
      background: rgba(242, 105, 37, 0.1);
      transition: background 0.3s ease;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
    }
    .stats-card {
      padding: 1.5rem;
      text-align: center;
      position: relative;
    }
    .stats-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 2px;
      background: linear-gradient(45deg, #F26925, #e07a3a);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    .form-input {
      @apply w-full p-4 rounded-xl bg-black text-white border-2 border-gray-800 
             focus:border-[#F26925] focus:ring-2 focus:ring-[#F26925]/20 focus:outline-none 
             transition-all duration-300 ease-in-out;
      backdrop-filter: blur(12px);
      background-color: #000000 !important;
      color: white !important;
      -webkit-text-fill-color: white;
      -webkit-background-clip: text;
    }
    .form-input:hover {
      @apply border-[#F26925]/50;
      background-color: #111111 !important;
      box-shadow: 0 0 20px rgba(242, 105, 37, 0.1);
    }
    .form-input::placeholder {
      @apply text-gray-500;
    }
    .form-group {
      @apply relative;
    }
    .form-label {
      @apply absolute -top-3 left-3 px-2 text-sm font-medium text-gray-300 bg-[#0b0b0b] 
             rounded-md transform transition-all duration-200;
    }
    .form-input:focus + .form-label,
    .form-input:not(:placeholder-shown) + .form-label {
      @apply -top-3 left-3 text-[#F26925] scale-90;
    }
  </style>
  <script>
    const stripe = Stripe('{{ stripe_public_key }}');
    
    async function payTicket(ticketId) {
      try {
        const response = await fetch(`/pay_ticket/${ticketId}`, {
          method: 'POST',
          credentials: 'same-origin'
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        if (data.session_id) {
          const result = await stripe.redirectToCheckout({ sessionId: data.session_id });
          if (result.error) throw new Error(result.error.message);
        } else {
          throw new Error('No session ID received from server.');
        }
      } catch (error) {
        console.error('Payment error:', error);
        alert('Payment processing failed. Please try again or contact support.');
      }
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const icon = document.getElementById(`${sectionId}-icon`);
      section.classList.toggle('hidden');
      if (icon) {
        icon.style.transform = section.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize all sections as visible
      document.querySelectorAll('[id$="-section"]').forEach(section => {
        section.classList.remove('hidden');
      });
    });
  </script>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="upike-card p-8 rounded-2xl mb-8">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="text-center md:text-left mb-4 md:mb-0">
          <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#F26925] to-[#e07a3a] animate-pulse">
            UPike Parking Portal
          </h1>
          <p class="text-xl mt-2 text-gray-300">Welcome back, {{ student.first_name }} {{ student.last_name }}</p>
        </div>
        <a href="{{ url_for('logout') }}" class="upike-button text-white font-semibold">
          Sign Out
        </a>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-6">
          {% for category, message in messages %}
            <div class="upike-card p-4 animate-fade-in flex items-center justify-between">
              <p class="text-lg {% if category == 'success' %}text-green-400{% elif category == 'warning' %}text-yellow-400{% else %}text-red-400{% endif %}">
                {{ message }}
              </p>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Stats Overview -->
    <div class="stats-grid mb-8">
      <div class="upike-card stats-card">
        <h3 class="text-lg font-semibold text-gray-400">Total Tickets</h3>
        <p class="text-4xl font-bold mt-2">{{ tickets|length }}</p>
      </div>
      <div class="upike-card stats-card">
        <h3 class="text-lg font-semibold text-gray-400">Pending Tickets</h3>
        <p class="text-4xl font-bold mt-2">{{ tickets|selectattr('status', 'equalto', 'Pending')|list|length }}</p>
      </div>
      <div class="upike-card stats-card">
        <h3 class="text-lg font-semibold text-gray-400">Total Appeals</h3>
        <p class="text-4xl font-bold mt-2">{{ appeals|length }}</p>
      </div>
    </div>

    <!-- Personal Info Section -->
    <div class="upike-card p-6 rounded-2xl mb-8">
      <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('personal-info')">
        <h2 class="upike-subtitle text-2xl">Personal Information</h2>
        <svg id="personal-info-icon" class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <div id="personal-info" class="mt-6">
        <form method="POST" action="{{ url_for('student_dashboard') }}" class="space-y-6">
          {{ form.hidden_tag() }}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full md:col-span-2 lg:col-span-3">
              <div class="p-4 bg-gray-800/30 rounded-lg">
                <p class="text-gray-300">Student ID: <span class="font-semibold text-white">{{ student.id }}</span> (cannot be changed)</p>
              </div>
            </div>
            
            {% for field in [form.email, form.permit_number, form.phone_number, form.permit_type, form.residence,
                           form.first_name, form.last_name, form.vehicle_color, form.license_plate_number,
                           form.license_plate_state, form.vehicle_year, form.make, form.model, form.password] %}
              <div class="form-group">
                {% if field.type == 'PasswordField' %}
                  {{ field(class="form-input", placeholder="Enter new password to change", style="background-color: #000000; color: white;") }}
                {% else %}
                  {{ field(class="form-input", placeholder=field.label.text, style="background-color: #000000; color: white;") }}
                {% endif %}
                <label class="form-label">{{ field.label }}</label>
                {% for error in field.errors %}
                  <span class="text-red-400 text-sm block mt-1">{{ error }}</span>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
          <div class="flex justify-end mt-6">
            <button type="submit" class="upike-button text-white font-semibold">
              Update Information
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tickets Section -->
    <div class="upike-card p-6 rounded-2xl mb-8">
      <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('ticket-section')">
        <h2 class="upike-subtitle text-2xl">Your Tickets</h2>
        <svg id="ticket-section-icon" class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <div id="ticket-section" class="mt-6">
        {% if tickets %}
          <div class="overflow-x-auto">
            <table class="w-full border-collapse text-gray-200 table-hover">
              <thead>
                <tr class="bg-gray-800/50">
                  <th class="p-4 text-left font-semibold rounded-tl-lg">ID</th>
                  <th class="p-4 text-left font-semibold">Date</th>
                  <th class="p-4 text-left font-semibold">Reason</th>
                  <th class="p-4 text-left font-semibold">Amount</th>
                  <th class="p-4 text-left font-semibold">Status</th>
                  <th class="p-4 text-left font-semibold rounded-tr-lg">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for ticket in tickets %}
                  <tr class="border-b border-gray-700/50 hover:bg-gray-800/30 transition-colors duration-200">
                    <td class="p-4">{{ ticket.id }}</td>
                    <td class="p-4">{{ ticket.issue_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="p-4">{{ ticket.reason }}</td>
                    <td class="p-4">${{ "%.2f" % ticket.amount }}</td>
                    <td class="p-4">
                      <span class="px-3 py-1 rounded-full text-sm font-medium
                        {% if ticket.status == 'Pending' %}bg-yellow-500/20 text-yellow-300
                        {% elif ticket.status == 'Paid' %}bg-green-500/20 text-green-300
                        {% elif ticket.status == 'Appealed' %}bg-blue-500/20 text-blue-300
                        {% endif %}">
                        {{ ticket.status }}
                      </span>
                    </td>
                    <td class="p-4">
                      <div class="flex space-x-3">
                        {% if ticket.status == 'Pending' %}
                          <button onclick="payTicket('{{ ticket.id }}')" class="upike-button text-white py-2 px-4 text-sm">
                            Pay Now
                          </button>
                          <a href="{{ url_for('appeal_ticket', ticket_id=ticket.id) }}" class="upike-button text-white py-2 px-4 text-sm">
                            Appeal
                          </a>
                        {% elif ticket.status == 'Paid' %}
                          <span class="text-green-400 font-medium">Completed</span>
                        {% elif ticket.status == 'Appealed' %}
                          <span class="text-blue-400 font-medium">Under Review</span>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-8">
            <p class="text-gray-400">No tickets have been issued.</p>
            <p class="text-gray-500 text-sm mt-2">Keep following parking regulations!</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Appeals Section -->
    <div class="upike-card p-6 rounded-2xl">
      <div class="flex items-center justify-between cursor-pointer" onclick="toggleSection('appeal-section')">
        <h2 class="upike-subtitle text-2xl">Your Appeals</h2>
        <svg id="appeal-section-icon" class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <div id="appeal-section" class="mt-6">
        {% if appeals %}
          <div class="overflow-x-auto">
            <table class="w-full border-collapse text-gray-200 table-hover">
              <thead>
                <tr class="bg-gray-800/50">
                  <th class="p-4 text-left font-semibold rounded-tl-lg">Appeal ID</th>
                  <th class="p-4 text-left font-semibold">Ticket ID</th>
                  <th class="p-4 text-left font-semibold">Description</th>
                  <th class="p-4 text-left font-semibold">Evidence</th>
                  <th class="p-4 text-left font-semibold">Status</th>
                  <th class="p-4 text-left font-semibold rounded-tr-lg">Decision Date</th>
                </tr>
              </thead>
              <tbody>
                {% for appeal in appeals %}
                  <tr class="border-b border-gray-700/50 hover:bg-gray-800/30 transition-colors duration-200">
                    <td class="p-4">{{ appeal.id }}</td>
                    <td class="p-4">{{ appeal.ticket_id }}</td>
                    <td class="p-4">
                      <div class="max-w-md overflow-hidden text-ellipsis">
                        {{ appeal.appeal_text }}
                      </div>
                    </td>
                    <td class="p-4">
                      {% if appeal.media_data %}
                        <a href="{{ url_for('appeal_media', appeal_id=appeal.id) }}" 
                           class="text-[#F26925] hover:text-[#e07a3a] transition-colors duration-200 flex items-center gap-2"
                           target="_blank">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          View
                        </a>
                      {% else %}
                        <span class="text-gray-500">None</span>
                      {% endif %}
                    </td>
                    <td class="p-4">
                      <span class="px-3 py-1 rounded-full text-sm font-medium
                        {% if appeal.status == 'pending' %}bg-yellow-500/20 text-yellow-300
                        {% elif appeal.status == 'approved' %}bg-green-500/20 text-green-300
                        {% elif appeal.status == 'rejected' %}bg-red-500/20 text-red-300
                        {% endif %}">
                        {{ appeal.status|title }}
                      </span>
                    </td>
                    <td class="p-4">
                      {% if appeal.decision_date %}
                        {{ appeal.decision_date.strftime('%Y-%m-%d %H:%M') }}
                      {% else %}
                        <span class="text-gray-500">Pending</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-8">
            <p class="text-gray-400">No appeals have been submitted.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</body>
</html>